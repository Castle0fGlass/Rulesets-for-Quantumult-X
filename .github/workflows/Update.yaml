name: Update Quantumult X Rules

on:
  schedule:
    workflow_dispatch:
    # 每周一 UTC 时间凌晨 2 点运行
    - cron: '0 2 * * 1'

jobs:
  update-rules:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Subconverter
        run: |
          SUB_VERSION="v0.9.0"
          
          echo "Downloading subconverter version ${SUB_VERSION}..."
          wget "https://github.com/tindy2013/subconverter/releases/download/${SUB_VERSION}/subconverter-linux-amd64.tar.gz" -O subconverter.tar.gz
          
          echo "Extracting subconverter..."
          tar -xzf subconverter.tar.gz
          
          if [ -f "subconverter-linux-amd64/subconverter" ]; then
            echo "Found subconverter in subfolder, moving it..."
            mv subconverter-linux-amd64/subconverter .
            rm -rf subconverter-linux-amd64 # 清理空文件夹
          elif [ ! -f "subconverter" ]; then
            echo "Error: subconverter executable not found in current directory after extraction."
            ls -R
            exit 1
          fi

          echo "Granting execute permission to subconverter..."
          chmod +x subconverter
          
          # 将 subconverter 可执行文件移动到 PATH 中，以便在后续步骤中直接调用
          echo "Moving subconverter to /usr/local/bin..."
          sudo mv subconverter /usr/local/bin/
          
          echo "subconverter setup complete and moved to /usr/local/bin."

      - name: Process and update LAN.snippet
        run: |
          # 由于 subconverter 已在 PATH 中，可以直接调用
          curl -sS "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/refs/heads/master/Clash/Providers/LocalAreaNetwork.yaml" | subconverter -t quantumultx -n DIRECT > LAN.snippet

      - name: Process and update BlockAdAlliance.snippet
        run: |
          curl -sS "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/refs/heads/master/Clash/Providers/BanAD.yaml" | subconverter -t quantumultx -n REJECT > BlockAdAlliance.snippet

      - name: Process and update BlockAds.snippet
        run: |
          curl -sS "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/refs/heads/master/Clash/Providers/BanProgramAD.yaml" | subconverter -t quantumultx -n REJECT > BlockAds.snippet

      - name: Process and update ChinaDomain.snippet
        run: |
          curl -sS "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/refs/heads/master/Clash/Providers/ChinaDomain.yaml" | subconverter -t quantumultx -n DIRECT > ChinaDomain.snippet

      - name: Process and update Apple.snippet
        run: |
          curl -sS "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/refs/heads/master/Clash/Providers/Apple.yaml" | subconverter -t quantumultx -n DIRECT > Apple.snippet

      - name: Process and update Microsoft.snippet
        run: |
          curl -sS "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/refs/heads/master/Clash/Providers/Ruleset/Microsoft.yaml" | subconverter -t quantumultx -n DIRECT > Microsoft.snippet

      - name: Process and update ProxyLite.snippet
        run: |
          curl -sS "https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/refs/heads/master/Clash/Providers/ProxyLite.yaml" | subconverter -t quantumultx -n PROXY > ProxyLite.snippet

      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add *.snippet
          git commit -m "自动更新 Quantumult X 规则" || echo "没有新的规则更新，跳过提交"
          git push
